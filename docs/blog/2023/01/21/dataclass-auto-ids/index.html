
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dataclass Auto IDs - A Bit Curious</title>
  <meta name="author" content="Leo Gzyl">

  
  <meta name="description" content="Imagine you are working on a project and have some code like this: 1
2
3
4
5
6
7
8
9
10
11
@dataclass
class Foo: bar: int baz: str
... for ... ... &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://github.com/leogzyl/leogzyl.github.io/blog/2023/01/21/dataclass-auto-ids/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="A Bit Curious" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">A Bit Curious</a></h1>
  
    <h2>Ramblings about programming, Linux & Life</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="github.com/leogzyl/leogzyl.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Dataclass Auto IDs</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-01-21T17:40:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2023</span></span> <span class='time'>5:40 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Imagine you are working on a project and have some code like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@dataclass</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
</span><span class='line'>    <span class="n">bar</span><span class="p">:</span> <span class="nb">int</span>
</span><span class='line'>    <span class="n">baz</span><span class="p">:</span> <span class="nb">str</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="o">...</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="n">the_bar</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="n">the_baz</span><span class="p">)</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="c"># do something with the foo&#39;s </span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you receive the requirement to assign serial ids to dataclasses being created (<code>Foo</code>s and others), for reference/ordering, etc.</p>

<p>It's worth mentioning that the objects are not going to be persisted, so as long as IDs are sequential per invocation/run/session, all is well.</p>

<p>After some digging around in the <code>itertools</code> module, you settle for something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@dataclass</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
</span><span class='line'>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
</span><span class='line'>    <span class="n">bar</span><span class="p">:</span> <span class="nb">int</span>
</span><span class='line'>    <span class="n">baz</span><span class="p">:</span> <span class="nb">str</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
</span><span class='line'>
</span><span class='line'><span class="n">ids</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="o">...</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">bar</span><span class="o">=</span><span class="n">the_bar</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="n">the_baz</span><span class="p">)</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works like a charm, except for the fact that you end up repeating the same code everywhere <code>Foo</code>s and other dataclasses are being instantiated.</p>

<p>Time to refactor!</p>

<p>The obvious place to move this is inside the dataclass itself, something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@dataclass</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AutoId</span><span class="p">():</span>
</span><span class='line'>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="s">&quot;_ids&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_ids</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@dataclass</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">AutoId</span><span class="p">):</span>
</span><span class='line'>    <span class="n">bar</span><span class="p">:</span> <span class="nb">int</span>
</span><span class='line'>    <span class="n">baz</span><span class="p">:</span> <span class="nb">str</span>
</span></code></pre></td></tr></table></div></figure>


<p>This encapsulates the counter logic in a dataclass that you can mix in with your existing ones. Each inheriting dataclass gets its own independent counter and <code>id</code> field. Nice!</p>

<p>But there's one more thing that doesn't quite work with this approach. The generated ids for each class will keep increasing for the duration of the python process, you need some sort of scope...</p>

<p>Scope? that's what context managers are for. Let's try that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@dataclass</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AutoId</span><span class="p">():</span>
</span><span class='line'>    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@classmethod</span>
</span><span class='line'>    <span class="nd">@contextmanager</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">auto_ids</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="n">cls</span><span class="o">.</span><span class="n">_ids</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="k">yield</span>
</span><span class='line'>        <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>            <span class="k">del</span> <span class="n">cls</span><span class="o">.</span><span class="n">_ids</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="s">&quot;_ids&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@dataclass</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">AutoId</span><span class="p">):</span>
</span><span class='line'>    <span class="n">bar</span><span class="p">:</span> <span class="nb">int</span>
</span><span class='line'>    <span class="n">baz</span><span class="p">:</span> <span class="nb">str</span>
</span></code></pre></td></tr></table></div></figure>


<p>This would be used in the wild like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">with</span> <span class="n">Foo</span><span class="o">.</span><span class="n">auto_ids</span><span class="p">():</span>
</span><span class='line'>    <span class="n">f1</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="s">&quot;baz&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">f2</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="s">&quot;baz&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">with</span> <span class="n">Foo</span><span class="o">.</span><span class="n">auto_ids</span><span class="p">():</span>
</span><span class='line'>    <span class="n">f3</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="s">&quot;baz&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">f4</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="s">&quot;baz&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">Foo(id=1, bar=1, baz=&#39;baz&#39;)
Foo(id=2, bar=2, baz=&#39;baz&#39;)
Foo(id=1, bar=1, baz=&#39;baz&#39;)
Foo(id=2, bar=2, baz=&#39;baz&#39;)</code></pre></div>


<p>You could save a couple of parenthesis by making <code>auto_ids</code> a class property, but keep in mind that will <a href="https://docs.python.org/3.11/library/functions.html#classmethod">no longer work after python 3.11</a></p>

<p>Granted, we ended up with a bit more complexity, but it's neatly hidden away in the core of your domain, giving you a clean API to work with.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Leo Gzyl</span></span>

      




<time class='entry-date' datetime='2023-01-21T17:40:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2023</span></span> <span class='time'>5:40 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/context-manager/'>context manager</a>, <a class='category' href='/blog/categories/contextlib/'>contextlib</a>, <a class='category' href='/blog/categories/dataclass/'>dataclass</a>, <a class='category' href='/blog/categories/dataclasses/'>dataclasses</a>, <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/refactoring/'>refactoring</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://github.com/leogzyl/leogzyl.github.io/blog/2023/01/21/dataclass-auto-ids/" data-via="leogzyl" data-counturl="https://github.com/leogzyl/leogzyl.github.io/blog/2023/01/21/dataclass-auto-ids/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2022/12/26/python-single-dispatch/" title="Previous Post: Pythonic Anti-IF: Single Dispatch">&laquo; Pythonic Anti-IF: Single Dispatch</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2023/01/21/dataclass-auto-ids/">Dataclass Auto IDs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/12/26/python-single-dispatch/">Pythonic Anti-IF: Single Dispatch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/03/20/terminal-bell-in-pycharm-oh-my-zsh/">Terminal Bell in PyCharm + Oh My Zsh</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leogzyl">@leogzyl</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leogzyl',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2023 - Leo Gzyl -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'a-bit-curious';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://github.com/leogzyl/leogzyl.github.io/blog/2023/01/21/dataclass-auto-ids/';
        var disqus_url = 'https://github.com/leogzyl/leogzyl.github.io/blog/2023/01/21/dataclass-auto-ids/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
